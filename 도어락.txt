/*
 * newproject.c
 *
 * Created: 2022-04-04 오전 10:37:43
 * Author : COMPUTER
 */ 

#include <stdio.h>
#include <string.h>
#include "keypad.h"
#include "lcd.h"
#include <util/delay.h>

#define PASS_SIZE 4
char user_word[PASS_SIZE] = {'0','0','0','0'}; // 패스워드 입력 문자열
char password[PASS_SIZE] = {'0','0','0','0'}; // 등록된 패스워드
	

void lcdCustomClear(); // lcd 커스텀 클리어

void set_password()
{
	unsigned char reg_number = 0; // 입력 받을 숫자
	unsigned int reg_count = 1; // 현재 입력해야할 위치 4자리 중 하나
	lcdCustomClear(); // LCD 클리어
	lcdPrint("Setting Password"); // 메세지 출력
	lcdGotoXY(0,1); // 입력 받을 숫자는 두번째 라인에서
	for(; reg_count<=4 ;){
		reg_number = keyscan(); // 숫자를 입력, 입력이 없을 땐 ?로 입력
		if(reg_number != '?'){ // 숫자를 입력 대기
			lcdDataWrite('*');
			user_word[reg_count-1] = reg_number; // 현재 입력한 숫자를 저장
			reg_count++; // 입력한 위치 변경
			_delay_ms(1000); // 채터링을 위한 딜레이
		}
	}
	
	strncpy(password,user_word,4); // 모든 입력이 끝나면 해당 패스워드를 등록
	
}

void insert_password()
{
	unsigned char in_number = 0; // 입력 받을 숫자
	unsigned int in_count = 1; // 현재 입력해야할 위치 4자리 중 하나
	lcdCustomClear();
	lcdPrint("Input num!");
	lcdGotoXY(0,1);
	for(; in_count<=4 ;){
		in_number = keyscan(); // 숫자를 입력, 입력이 없을 땐 ?로 입력
		if(in_number != '?'){ // 숫자를 입력 대기
			user_word[in_count-1] = in_number; // 현재 입력한 숫자를 저장
			lcdDataWrite(user_word[in_count-1]); // 비밀번호 보안으로 *로 출력
			in_count++; // 입력한 위치 변경
			_delay_ms(1000); // 채터링을 위한 딜레이
		}
	}
	
	lcdCustomClear();
	
	
	if(strncmp(password,user_word,4) == 0){
		lcdPrint("Open!");
		PORTB = 0xFF;
	} // 문열기 성공
	else{
		lcdPrint("Can't open!");
		for(int i=0 ; i<3 ; ++i){
			PORTB = 0xFF;
			_delay_ms(100);
			PORTB = 0x00;
			_delay_ms(100);
		} // LED IN<----->OFF
	} // 문열기 실패
	
	_delay_ms(1000);
	
	
 }


int main(void)
{   
   //unsigned char key;
    
	
    // DDRC = 0xFF;
	unsigned char menu = 0;
    DDRB = 0xFF; // led
    DDRE = 0xFF;
	// DDRG= 0XFF;
	
	lcdInit();
	lcdCustomClear();
	init_keypad();
	
	lcdGotoXY(5,0);
	lcdPrint("Welcome");  // 환영 메세지 출력
	_delay_ms(1000);
	set_password();

	for(;;)
	{
		lcdCustomClear();
		lcdPrint("1. Registration");
		lcdGotoXY(0,1);
		lcdPrint("2. Input");
		// 메뉴 출력
	
		menu = keyscan(); // 메뉴 입력
	
		if(menu == '1'){
			_delay_ms(500);
			set_password();
		} // 등록 구현 완료
		else if(menu == '2'){
			_delay_ms(500);
			insert_password();
		} // 비밀번호 입력 모드
		// 메뉴선택
	
		_delay_ms(300);
	}
}
void lcdCustomClear(){
	lcdClear();
	lcdPrintData("     ",5);
}